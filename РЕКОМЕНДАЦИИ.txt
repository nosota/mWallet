  üìä –ê–ù–ê–õ–ò–ó –í–´–ü–û–õ–ù–ò–ú–û–°–¢–ò –û–ü–ï–†–ê–¶–ò–ô SETTLEMENT –ò REFUND

  ‚úÖ –û–±—â–∏–π –≤–µ—Ä–¥–∏–∫—Ç: –û–ë–ï –û–ü–ï–†–ê–¶–ò–ò –í–´–ü–û–õ–ù–ò–ú–´

  ---
  1Ô∏è‚É£ SETTLEMENT ‚Äî –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å –º–µ—Ä—á–∞–Ω—Ç–æ–º

  –°—Ç–∞—Ç—É—Å: ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –í–´–ü–û–õ–ù–ò–ú–û –Ω–∞ —Ç–µ–∫—É—â–µ–º API

  –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:

  –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:
  1. ‚úÖ –¢–∏–ø—ã –∫–æ—à–µ–ª—å–∫–æ–≤ ‚Äî –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∏–ø—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç:
    - USER ‚Äî –∫–æ—à–µ–ª–µ–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    - MERCHANT ‚Äî –∫–æ—à–µ–ª–µ–∫ –º–µ—Ä—á–∞–Ω—Ç–∞
    - ESCROW ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å—Ä–µ–¥—Å—Ç–≤
    - SYSTEM ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –∫–æ–º–∏—Å—Å–∏–π
  2. ‚úÖ –û–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (LedgerApi.java:44-98):
    - holdDebit() ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤
    - holdCredit() ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞—á–∏—Å–ª–µ–Ω–∏—é
    - settle() ‚Äî —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    - TransactionStatus.SETTLED ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
  3. ‚úÖ Transaction Groups (LedgerApi.java:102-142):
    - createTransactionGroup() ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    - settleTransactionGroup() ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–∞—è —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
    - Zero-sum reconciliation ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
  4. ‚úÖ –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ (TransactionService.java:104-109):
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–ª–µ–≤–æ–π —Å—É–º–º—ã –ø–µ—Ä–µ–¥ settlement
    - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤

  –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Settlement:

  –°—Ü–µ–Ω–∞—Ä–∏–π: Settlement –º–µ—Ä—á–∞–Ω—Ç–∞ –Ω–∞ 4000‚ÇΩ —Å –∫–æ–º–∏—Å—Å–∏–µ–π 3%

  1. –°–æ–∑–¥–∞—Ç—å transaction group:
     UUID settlementGroup = createTransactionGroup()

  2. –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ escrow:
     holdDebit(escrowWalletId, 4000, settlementGroup)  // -4000‚ÇΩ

  3. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ä—á–∞–Ω—Ç—É:
     holdCredit(merchantWalletId, 3880, settlementGroup)  // +3880‚ÇΩ

  4. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–æ–º–∏—Å—Å–∏—é —Å–∏—Å—Ç–µ–º–µ:
     holdCredit(systemWalletId, 120, settlementGroup)  // +120‚ÇΩ

  5. –§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å settlement:
     settleTransactionGroup(settlementGroup)

     –ü—Ä–æ–≤–µ—Ä–∫–∞: -4000 + 3880 + 120 = 0 ‚úì

  –†–µ–∑—É–ª—å—Ç–∞—Ç:
     Escrow:   -4000‚ÇΩ (SETTLED)
     Merchant: +3880‚ÇΩ (SETTLED)
     System:   +120‚ÇΩ  (SETTLED)

  ‚ö†Ô∏è –ß—Ç–æ –ù–£–ñ–ù–û –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è production:

  –•–æ—Ç—è —Ç–µ–∫—É—â–∏–π API —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç settlement, –¥–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω—É–∂–Ω–æ:

  1. SettlementService (–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å)

  @Service
  public class SettlementService {

      // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å settlement –¥–ª—è –º–µ—Ä—á–∞–Ω—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
      SettlementCalculation calculateSettlement(
          Long merchantId, 
          LocalDate from, 
          LocalDate to
      );

      // –í—ã–ø–æ–ª–Ω–∏—Ç—å settlement –æ–¥–Ω–æ–≥–æ –º–µ—Ä—á–∞–Ω—Ç–∞
      UUID settleMerchant(
          Long merchantId, 
          SettlementCalculation calculation
      );

      // –ú–∞—Å—Å–æ–≤—ã–π settlement –≤—Å–µ—Ö –º–µ—Ä—á–∞–Ω—Ç–æ–≤
      List<SettlementResult> dailySettlement(LocalDate date);

      // –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é settlements
      PagedResponse<SettlementHistory> getSettlementHistory(
          Long merchantId, 
          Pageable pageable
      );
  }

  2. –ù–æ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

  // Settlement –∑–∞–ø–∏—Å—å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
  @Entity
  public class Settlement {
      @Id
      private UUID id;
      private Long merchantId;
      private Long totalAmount;        // –û–±—â–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π
      private Long feeAmount;          // –ö–æ–º–∏—Å—Å–∏—è
      private Long netAmount;          // –ö –≤—ã–ø–ª–∞—Ç–µ
      private BigDecimal feePercent;   // % –∫–æ–º–∏—Å—Å–∏–∏
      private LocalDateTime settledAt;
      private UUID transactionGroupId; // –°–≤—è–∑—å —Å ledger
      private SettlementStatus status; // PENDING, COMPLETED, FAILED
  }

  3. Repository –º–µ—Ç–æ–¥—ã

  // –ù–∞–π—Ç–∏ –≤—Å–µ HOLD —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–µ—Ä—á–∞–Ω—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
  List<Transaction> findHoldTransactionsForMerchant(
      Long merchantId,
      LocalDate from,
      LocalDate to,
      TransactionStatus status
  );

  // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—É –¥–ª—è settlement
  Long calculateSettlementAmount(
      Long merchantId, 
      LocalDate from, 
      LocalDate to
  );

  4. API endpoints (tier1 –∏–ª–∏ tier2)

  POST /api/v1/settlement/merchants/{merchantId}/calculate
  POST /api/v1/settlement/merchants/{merchantId}/execute
  POST /api/v1/settlement/batch/daily
  GET  /api/v1/settlement/merchants/{merchantId}/history
  GET  /api/v1/settlement/{settlementId}

  ---
  2Ô∏è‚É£ REFUND ‚Äî –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ü–û–°–õ–ï settlement

  –°—Ç–∞—Ç—É—Å: ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û –í–´–ü–û–õ–ù–ò–ú–û (—Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è)

  –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:

  –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
  - ‚úÖ release() ‚Äî –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –î–û settlement (–∏–∑ HOLD ‚Üí RELEASED)
  - ‚úÖ cancel() ‚Äî –æ—Ç–º–µ–Ω–∞ –î–û settlement (–∏–∑ HOLD ‚Üí CANCELLED)
  - ‚ùå –ù–ï–¢ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ü–û–°–õ–ï settlement

  –ü—Ä–æ–±–ª–µ–º–∞:
  –¢–µ–∫—É—â–∏–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª (WalletService.java:199-256):

  HOLD ‚Üí SETTLED     (—Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è)
  HOLD ‚Üí RELEASED    (–≤–æ–∑–≤—Ä–∞—Ç –î–û settlement)
  HOLD ‚Üí CANCELLED   (–æ—Ç–º–µ–Ω–∞ –î–û settlement)

  ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: SETTLED ‚Üí REFUNDED (–≤–æ–∑–≤—Ä–∞—Ç –ü–û–°–õ–ï settlement)

  –ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ: Release vs Refund

  |                  | Release (–µ—Å—Ç—å)          | Refund (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å)                   |
  |------------------|-------------------------|-------------------------------------------|
  | –ö–æ–≥–¥–∞            | –î–æ settlement           | –ü–æ—Å–ª–µ settlement                          |
  | –û—Ç–∫—É–¥–∞ –¥–µ–Ω—å–≥–∏    | –° ESCROW                | –°–æ —Å—á—ë—Ç–∞ –º–µ—Ä—á–∞–Ω—Ç–∞                         |
  | –ú–µ—Ö–∞–Ω–∏–∑–º         | –û—Ç–º–µ–Ω–∞ HOLD —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏  | –ù–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è                          |
  | –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ      | –ò–Ω–≤–µ—Ä—Å–∏—è (DEBIT‚ÜíCREDIT) | –ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥ (Merchant‚ÜíBuyer)           |
  | –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ | –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è            | –¢—Ä–µ–±—É–µ—Ç—Å—è (—É –º–µ—Ä—á–∞–Ω—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–µ–Ω—å–≥–∏) |

  üìã –ß—Ç–æ –ù–£–ñ–ù–û –∏–∑–º–µ–Ω–∏—Ç—å:

  1. –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å REFUNDED

  // api/model/TransactionStatus.java
  public enum TransactionStatus {
      HOLD,
      SETTLED,
      RELEASED,   // –¥–æ settlement
      CANCELLED,  // –¥–æ settlement
      REFUNDED    // ‚Üê –ù–û–í–´–ô: –ø–æ—Å–ª–µ settlement
  }

  2. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ refund –≤ WalletService

  // WalletService.java
  @Transactional
  public Integer refund(
      @NotNull Integer fromWalletId,  // –º–µ—Ä—á–∞–Ω—Ç
      @NotNull Integer toWalletId,    // –ø–æ–∫—É–ø–∞—Ç–µ–ª—å  
      @Positive Long amount,
      @NotNull UUID originalReferenceId,
      @NotNull UUID refundReferenceId
  ) throws WalletNotFoundException, InsufficientFundsException {

      // 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è SETTLED
      Transaction originalTx = transactionRepository
          .findByWalletIdAndReferenceIdAndStatuses(
              fromWalletId,
              originalReferenceId,
              TransactionStatus.SETTLED
          )
          .orElseThrow(() -> new TransactionNotFoundException(
              "Original SETTLED transaction not found"
          ));

      // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –º–µ—Ä—á–∞–Ω—Ç–∞
      Long availableBalance = walletBalanceService.getAvailableBalance(fromWalletId);
      if (availableBalance < amount) {
          throw new InsufficientFundsException(
              "Insufficient funds for refund"
          );
      }

      // 3. –°–æ–∑–¥–∞—Ç—å REFUNDED debit —Å –º–µ—Ä—á–∞–Ω—Ç–∞
      Transaction refundDebit = new Transaction();
      refundDebit.setWalletId(fromWalletId);
      refundDebit.setAmount(-amount);
      refundDebit.setType(TransactionType.DEBIT);
      refundDebit.setStatus(TransactionStatus.REFUNDED);
      refundDebit.setReferenceId(refundReferenceId);
      refundDebit.setConfirmRejectTimestamp(LocalDateTime.now());
      refundDebit.setDescription("Refund for " + originalReferenceId);

      transactionRepository.save(refundDebit);

      // 4. –°–æ–∑–¥–∞—Ç—å REFUNDED credit –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
      Transaction refundCredit = new Transaction();
      refundCredit.setWalletId(toWalletId);
      refundCredit.setAmount(amount);
      refundCredit.setType(TransactionType.CREDIT);
      refundCredit.setStatus(TransactionStatus.REFUNDED);
      refundCredit.setReferenceId(refundReferenceId);
      refundCredit.setConfirmRejectTimestamp(LocalDateTime.now());
      refundCredit.setDescription("Refund from " + originalReferenceId);

      return transactionRepository.save(refundCredit).getId();
  }

  3. –î–æ–±–∞–≤–∏—Ç—å RefundService (–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ª–æ–≥–∏–∫–∞)

  @Service
  public class RefundService {

      // Full refund (100%)
      UUID refundOrder(
          UUID orderReferenceId,
          String reason
      );

      // Partial refund (—á–∞—Å—Ç—å —Å—É–º–º—ã)
      UUID partialRefund(
          UUID orderReferenceId,
          Long amount,
          String reason
      );

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ refund
      boolean canRefund(UUID orderReferenceId);

      // –ò—Å—Ç–æ—Ä–∏—è refunds
      List<RefundHistory> getRefundHistory(
          Long merchantId,
          LocalDate from,
          LocalDate to
      );
  }

  4. –ù–æ–≤–∞—è —Å—É—â–Ω–æ—Å—Ç—å Refund

  @Entity
  public class Refund {
      @Id
      private UUID id;
      private UUID originalTransactionGroupId;
      private UUID refundTransactionGroupId;
      private Long merchantWalletId;
      private Long buyerWalletId;
      private Long refundAmount;
      private Long originalAmount;
      private RefundType type;  // FULL, PARTIAL
      private String reason;
      private LocalDateTime createdAt;
      private RefundStatus status;
  }

  5. –û–±–Ω–æ–≤–∏—Ç—å API (LedgerApi.java)

  // –ù–æ–≤—ã–µ endpoints –¥–ª—è refund
  @PostMapping("/refund/full")
  ResponseEntity<RefundResponse> refundFull(
      @RequestParam UUID orderReferenceId,
      @RequestParam String reason
  );

  @PostMapping("/refund/partial")
  ResponseEntity<RefundResponse> refundPartial(
      @RequestParam UUID orderReferenceId,
      @RequestParam Long amount,
      @RequestParam String reason
  );

  @GetMapping("/refund/{refundId}")
  ResponseEntity<RefundResponse> getRefund(
      @PathVariable UUID refundId
  );

  6. –û–±–Ω–æ–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Flyway

  -- V{next}__add_refunded_status.sql

  -- –î–æ–±–∞–≤–∏—Ç—å REFUNDED –≤ enum (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è enum –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î)
  ALTER TYPE transaction_status ADD VALUE IF NOT EXISTS 'REFUNDED';

  -- –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É refund
  CREATE TABLE refund (
      id UUID PRIMARY KEY,
      original_transaction_group_id UUID NOT NULL,
      refund_transaction_group_id UUID NOT NULL,
      merchant_wallet_id INTEGER NOT NULL,
      buyer_wallet_id INTEGER NOT NULL,
      refund_amount BIGINT NOT NULL,
      original_amount BIGINT NOT NULL,
      type VARCHAR(20) NOT NULL,
      reason TEXT,
      status VARCHAR(20) NOT NULL,
      created_at TIMESTAMP NOT NULL DEFAULT NOW(),

      CONSTRAINT fk_original_group
          FOREIGN KEY (original_transaction_group_id)
          REFERENCES transaction_group(id),
      CONSTRAINT fk_refund_group
          FOREIGN KEY (refund_transaction_group_id)
          REFERENCES transaction_group(id)
  );

  CREATE INDEX idx_refund_original_group
      ON refund(original_transaction_group_id);
  CREATE INDEX idx_refund_merchant
      ON refund(merchant_wallet_id);
  CREATE INDEX idx_refund_created_at
      ON refund(created_at);

  ---
  üìä –°–†–ê–í–ù–ò–¢–ï–õ–¨–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê

  | –û–ø–µ—Ä–∞—Ü–∏—è   | –í—ã–ø–æ–ª–Ω–∏–º–æ—Å—Ç—å          | –¢—Ä–µ–±—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è                                                            | –°–ª–æ–∂–Ω–æ—Å—Ç—å                                |
  |------------|-----------------------|--------------------------------------------------------------------------------|------------------------------------------|
  | Settlement | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–∏–º–æ | –°–æ–∑–¥–∞—Ç—å SettlementService–î–æ–±–∞–≤–∏—Ç—å endpoints–î–æ–±–∞–≤–∏—Ç—å entity Settlement          | üü¢ –ù–∏–∑–∫–∞—è(–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API) |
  | Refund     | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏  | –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å REFUNDED–°–æ–∑–¥–∞—Ç—å RefundService–û–±–Ω–æ–≤–∏—Ç—å WalletService–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î | üü° –°—Ä–µ–¥–Ω—è—è(–Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å + –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞) |

  ---
  üìù –ü–õ–ê–ù –ò–ó–ú–ï–ù–ï–ù–ò–ô (–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è)

  Phase 1: Settlement (1-2 –¥–Ω—è)

  1. ‚úÖ –°–æ–∑–¥–∞—Ç—å SettlementService
  2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å entity Settlement
  3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ü–∏—é –∫–æ–º–∏—Å—Å–∏–π
  4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å API endpoints
  5. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å unit tests
  6. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

  –†–∏—Å–∫–∏: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–æ—Ç–æ–≤—ã–π API)

  ---
  Phase 2: Refund (2-3 –¥–Ω—è)

  1. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å REFUNDED –≤ TransactionStatus
  2. ‚ö†Ô∏è –û–±–Ω–æ–≤–∏—Ç—å Flyway –º–∏–≥—Ä–∞—Ü–∏–∏
  3. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ refund() –≤ WalletService
  4. ‚ö†Ô∏è –°–æ–∑–¥–∞—Ç—å RefundService
  5. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å entity Refund
  6. ‚ö†Ô∏è –û–±–Ω–æ–≤–∏—Ç—å API (LedgerApi)
  7. ‚ö†Ô∏è –û–±–Ω–æ–≤–∏—Ç—å WalletBalanceService (—É—á–µ—Ç REFUNDED)
  8. ‚ö†Ô∏è –ù–∞–ø–∏—Å–∞—Ç—å integration tests
  9. ‚ö†Ô∏è –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

  –†–∏—Å–∫–∏:
  - –ò–∑–º–µ–Ω–µ–Ω–∏–µ enum –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–ø–∞ –≤ PostgreSQL
  - –ù—É–∂–Ω–æ —É—á–µ—Å—Ç—å REFUNDED –≤ —Ä–∞—Å—á–µ—Ç–µ –±–∞–ª–∞–Ω—Å–∞
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å archiving –ø—Ä–æ—Ü–µ—Å—Å–æ–º

  ---
  Phase 3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

  1. üîµ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π settlement –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
  2. üîµ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ settlement/refund
  3. üîµ Dashboard –¥–ª—è –º–µ—Ä—á–∞–Ω—Ç–æ–≤
  4. üîµ –≠–∫—Å–ø–æ—Ä—Ç settlement –æ—Ç—á–µ—Ç–æ–≤
  5. üîµ Partial refund —Å –∫–æ–º–∏—Å—Å–∏–µ–π
  6. üîµ Refund —Å —É–¥–µ—Ä–∂–∞–Ω–∏–µ–º –∫–æ–º–∏—Å—Å–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

  ---
  ‚úÖ –ò–¢–û–ì–û–í–´–ï –í–´–í–û–î–´

  Settlement

  –í–µ—Ä–¥–∏–∫—Ç: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–∏–º–æ –Ω–∞ —Ç–µ–∫—É—â–µ–º API

  –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ mWallet –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ settlement —á–µ—Ä–µ–∑:
  - Transaction groups –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
  - Zero-sum reconciliation –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
  - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –∫–æ—à–µ–ª—å–∫–æ–≤ (ESCROW, MERCHANT, SYSTEM)
  - –°—Ç–∞—Ç—É—Å SETTLED –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

  –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (SettlementService) –ø–æ–≤–µ—Ä—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ API.

  ---
  Refund

  –í–µ—Ä–¥–∏–∫—Ç: ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

  –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ù–ï —Ä–∞–∑–ª–∏—á–∞–µ—Ç:
  - –í–æ–∑–≤—Ä–∞—Ç –î–û settlement (RELEASED/CANCELLED) ‚Äî –µ—Å—Ç—å
  - –í–æ–∑–≤—Ä–∞—Ç –ü–û–°–õ–ï settlement (REFUNDED) ‚Äî –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å

  –¢—Ä–µ–±—É–µ—Ç—Å—è:
  1. –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å REFUNDED
  2. –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä—è–º—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–Ω–µ –∏–Ω–≤–µ—Ä—Å–∏—è)
  3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –º–µ—Ä—á–∞–Ω—Ç–∞ –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º

  –°–ª–æ–∂–Ω–æ—Å—Ç—å: –°—Ä–µ–¥–Ω—è—è, –Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ.

  ---
  üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

  1. [DONE] –ù–∞—á–∞—Ç—å —Å Settlement ‚Äî –±—ã—Å—Ç—Ä–∞—è –ø–æ–±–µ–¥–∞, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è core –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
  2. [DONE] –ó–∞—Ç–µ–º Refund ‚Äî —Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
  3. [DONE] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é ‚Äî docs/architecture/transaction-lifecycle.md –Ω—É–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–æ–≤—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
  4. [DONE] –ù–∞–ø–∏—Å–∞—Ç—å integration tests ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è refund (–ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ refund)
  5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π settlement –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
  6. –≠–∫—Å–ø–æ—Ä—Ç settlement –æ—Ç—á–µ—Ç–æ–≤
  7. Partial refund —Å –∫–æ–º–∏—Å—Å–∏–µ–π
  8. Refund —Å —É–¥–µ—Ä–∂–∞–Ω–∏–µ–º –∫–æ–º–∏—Å—Å–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

  –ì–æ—Ç–æ–≤ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ!

