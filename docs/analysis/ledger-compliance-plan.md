# –ü–ª–∞–Ω –ü—Ä–∏–≤–µ–¥–µ–Ω–∏—è –∫ Ledger-–°—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º

**–í–µ—Ä—Å–∏—è**: 1.0
**–î–∞—Ç–∞**: 27 –¥–µ–∫–∞–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å**: üìã Draft ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –í—ã—Å–æ–∫–∏–π

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
2. [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ú–∏–≥—Ä–∞—Ü–∏–∏](#—Å—Ç—Ä–∞—Ç–µ–≥–∏—è-–º–∏–≥—Ä–∞—Ü–∏–∏)
3. [–§–∞–∑–∞ 1: –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è –∏ –°—Ç–∞—Ç—É—Å—ã](#—Ñ–∞–∑–∞-1-—Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è-–∏-—Å—Ç–∞—Ç—É—Å—ã)
4. [–§–∞–∑–∞ 2: Settlement –ú–µ—Ö–∞–Ω–∏–∑–º](#—Ñ–∞–∑–∞-2-settlement-–º–µ—Ö–∞–Ω–∏–∑–º)
5. [–§–∞–∑–∞ 3: Ledger Service](#—Ñ–∞–∑–∞-3-ledger-service)
6. [–§–∞–∑–∞ 4: Batch Processing](#—Ñ–∞–∑–∞-4-batch-processing)
7. [–§–∞–∑–∞ 5: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è](#—Ñ–∞–∑–∞-5-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è-–∏-—Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è)
8. [–†–∏—Å–∫–∏ –∏ –ú–∏—Ç–∏–≥–∞—Ü–∏—è](#—Ä–∏—Å–∫–∏-–∏-–º–∏—Ç–∏–≥–∞—Ü–∏—è)
9. [–ß–µ–∫–ª–∏—Å—Ç](#—á–µ–∫–ª–∏—Å—Ç)

---

## –û–±–∑–æ—Ä

### –¶–µ–ª—å

–ü—Ä–∏–≤–µ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç mWallet –∫ **—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ ledger** –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞–∫ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞ –ø–ª–∞—Ç—ë–∂–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.

### Scope

- ‚úÖ –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è (—Å—Ç–∞—Ç—É—Å—ã, –æ–ø–µ—Ä–∞—Ü–∏–∏)
- ‚úÖ Settlement –º–µ—Ö–∞–Ω–∏–∑–º
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ Release vs Cancel
- ‚úÖ Ledger Service –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ Batch processing
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –í–Ω–µ Scope

- ‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ)
- ‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏–µ double-entry –º–µ—Ö–∞–Ω–∏–∑–º–∞ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º)
- ‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –¥—Ä—É–≥—É—é –°–£–ë–î

### –û—Ü–µ–Ω–∫–∞ –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç

| –§–∞–∑–∞ | –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã | –†–∏—Å–∫ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|------|--------------|------|-----------|
| –§–∞–∑–∞ 1: –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è | 40 —á | –°—Ä–µ–¥–Ω–∏–π | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –§–∞–∑–∞ 2: Settlement | 60 —á | –í—ã—Å–æ–∫–∏–π | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –§–∞–∑–∞ 3: Ledger Service | 80 —á | –°—Ä–µ–¥–Ω–∏–π | üü° –í—ã—Å–æ–∫–∏–π |
| –§–∞–∑–∞ 4: Batch Processing | 100 —á | –í—ã—Å–æ–∫–∏–π | üü° –í—ã—Å–æ–∫–∏–π |
| –§–∞–∑–∞ 5: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 20 —á | –ù–∏–∑–∫–∏–π | üü¢ –°—Ä–µ–¥–Ω–∏–π |
| **–ò–¢–û–ì–û** | **300 —á** | - | - |

**–°—Ä–æ–∫**: 2-3 –º–µ—Å—è—Ü–∞ –ø—Ä–∏ –æ–¥–Ω–æ–º full-time —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–µ

---

## –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ú–∏–≥—Ä–∞—Ü–∏–∏

### –ü–æ–¥—Ö–æ–¥: –ü–æ—ç—Ç–∞–ø–Ω–∞—è –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑ Downtime

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å—Ç–∞—Ä–æ–π —Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º.

```
–®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å—Ç–∞—Ä—ã–º)
–®–∞–≥ 2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å—Ç–∞—Ä—ã–º)
–®–∞–≥ 3: –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã
–®–∞–≥ 4: –ü–æ–º–µ—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã @Deprecated
–®–∞–≥ 5: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã (—á–µ—Ä–µ–∑ N –º–µ—Å—è—Ü–µ–≤)
```

### –ü—Ä–∏–Ω—Ü–∏–ø—ã

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** ‚Äî —Å—Ç–∞—Ä—ã–π API –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
2. **Feature Flags** ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** ‚Äî –ø–æ—ç—Ç–∞–ø–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤
4. **Comprehensive Testing** ‚Äî –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
5. **Documentation First** ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –∫–æ–¥–æ–º

---

## –§–∞–∑–∞ 1: –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è –∏ –°—Ç–∞—Ç—É—Å—ã

**–¶–µ–ª—å**: –ü—Ä–∏–≤–µ—Å—Ç–∏ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –∫ ledger-—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º

**–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã**: 40 —á–∞—Å–æ–≤

**–†–∏—Å–∫**: –°—Ä–µ–¥–Ω–∏–π (–∏–∑–º–µ–Ω–µ–Ω–∏–µ core enum, —Ç—Ä–µ–±—É–µ—Ç —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

### 1.1. –ù–æ–≤—ã–µ –°—Ç–∞—Ç—É—Å—ã

#### –®–∞–≥ 1.1.1: –†–∞—Å—à–∏—Ä–∏—Ç—å TransactionStatus enum

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```java
public enum TransactionStatus {
    HOLD,      // –£–¥–µ—Ä–∂–∞–Ω–∏–µ
    RESERVE,   // –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è!)
    CONFIRMED, // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ (—Å–ª–∏—à–∫–æ–º –æ–±—â–µ–µ)
    REJECTED   // –û—Ç–∫–ª–æ–Ω–µ–Ω–æ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ç–µ—Ä–º–∏–Ω)
}
```

**–ù–æ–≤—ã–π –∫–æ–¥** (—Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é):
```java
public enum TransactionStatus {
    // === –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ ledger-—Å—Ç–∞—Ç—É—Å—ã ===
    HOLD,           // –£–¥–µ—Ä–∂–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ (–¥–ª—è –¥–µ–±–µ—Ç–∞ –∏ –∫—Ä–µ–¥–∏—Ç–∞)
    RELEASED,       // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (–ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π)
    CANCELLED,      // –û—Ç–º–µ–Ω–µ–Ω–æ (–¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π)
    SETTLED,        // –§–∏–Ω–∞–ª—å–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ (–ø–æ—Å–ª–µ release)

    // === Deprecated (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) ===
    @Deprecated(since = "2.0.0", forRemoval = true)
    RESERVE,        // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HOLD –≤–º–µ—Å—Ç–æ RESERVE

    @Deprecated(since = "2.0.0", forRemoval = true)
    CONFIRMED,      // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ RELEASED –∏–ª–∏ SETTLED

    @Deprecated(since = "2.0.0", forRemoval = true)
    REJECTED;       // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CANCELLED

    /**
     * –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ä—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –Ω–∞ –Ω–æ–≤—ã–µ
     */
    public TransactionStatus toNewStatus() {
        return switch (this) {
            case RESERVE -> HOLD;
            case CONFIRMED -> RELEASED;  // –∏–ª–∏ SETTLED (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
            case REJECTED -> CANCELLED;
            default -> this;
        };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å —Ñ–∏–Ω–∞–ª—å–Ω—ã–º
     */
    public boolean isFinal() {
        return this == SETTLED || this == CANCELLED;
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º
     */
    public boolean isTemporary() {
        return this == HOLD || this == RELEASED;
    }
}
```

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- `service/src/main/java/com/nosota/mwallet/model/TransactionStatus.java`

**–ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**:
```sql
-- V2.01__add_new_transaction_statuses.sql

-- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è enum type –≤ PostgreSQL)
-- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è VARCHAR, –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è

-- –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏, —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
SELECT DISTINCT status FROM transaction;
SELECT DISTINCT status FROM transaction_snapshot;
SELECT DISTINCT status FROM transaction_snapshot_archive;

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
-- –°—Ç–∞—Ä—ã–µ —Å—Ç–∞—Ç—É—Å—ã –æ—Å—Ç–∞—é—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
```

---

#### –®–∞–≥ 1.1.2: –î–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ä—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤

–°–æ–∑–¥–∞—Ç—å utility –∫–ª–∞—Å—Å –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞:

```java
/**
 * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º–∏ –∏ –Ω–æ–≤—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
 *
 * @since 2.0.0
 */
@Component
public class TransactionStatusMapper {

    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å –≤ –Ω–æ–≤—ã–π
     */
    public TransactionStatus mapToNewStatus(TransactionStatus oldStatus, TransactionType type) {
        return switch (oldStatus) {
            case RESERVE -> TransactionStatus.HOLD;
            case CONFIRMED -> {
                // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥: CONFIRMED –º–æ–∂–µ—Ç –±—ã—Ç—å RELEASED –∏–ª–∏ SETTLED
                // –ù—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                yield TransactionStatus.RELEASED; // –í—Ä–µ–º–µ–Ω–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ
            }
            case REJECTED -> TransactionStatus.CANCELLED;
            case HOLD, RELEASED, CANCELLED, SETTLED -> oldStatus;
        };
    }

    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –≤ —Å—Ç–∞—Ä—ã–π (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
     */
    public TransactionStatus mapToLegacyStatus(TransactionStatus newStatus) {
        return switch (newStatus) {
            case RELEASED, SETTLED -> TransactionStatus.CONFIRMED;
            case CANCELLED -> TransactionStatus.REJECTED;
            case HOLD -> TransactionStatus.HOLD;
            default -> newStatus;
        };
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞
     */
    public boolean needsMigration(TransactionStatus status) {
        return status == TransactionStatus.RESERVE
            || status == TransactionStatus.CONFIRMED
            || status == TransactionStatus.REJECTED;
    }
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/util/TransactionStatusMapper.java`

---

### 1.2. –û–±–Ω–æ–≤–∏—Ç—å –°–µ—Ä–≤–∏—Å—ã

#### –®–∞–≥ 1.2.1: WalletService ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã

**–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã** (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å—Ç–∞—Ä—ã–º):

```java
@Service
@Validated
@AllArgsConstructor
@Slf4j
public class WalletService {

    // === –ù–û–í–´–ï –ú–ï–¢–û–î–´ (ledger-—Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã) ===

    /**
     * –£–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è –¥–µ–±–µ—Ç–∞ (—Å–ø–∏—Å–∞–Ω–∏–µ).
     * –ó–∞–º–µ–Ω—è–µ—Ç –º–µ—Ç–æ–¥ hold() —Å —è–≤–Ω–æ–π —Å–µ–º–∞–Ω—Ç–∏–∫–æ–π.
     *
     * @since 2.0.0
     */
    @Transactional
    public Integer holdDebit(@NotNull Integer walletId,
                             @Positive Long amount,
                             @NotNull UUID referenceId)
            throws WalletNotFoundException, InsufficientFundsException {

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        Long availableBalance = walletBalanceService.getAvailableBalance(walletId);
        if (availableBalance < amount) {
            throw new InsufficientFundsException(
                "Insufficient funds in wallet " + walletId
            );
        }

        return createTransaction(
            walletId,
            -amount,
            TransactionType.DEBIT,
            TransactionStatus.HOLD,
            referenceId
        );
    }

    /**
     * –£–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–ª—è –∫—Ä–µ–¥–∏—Ç–∞ (–∑–∞—á–∏—Å–ª–µ–Ω–∏–µ).
     * –ó–∞–º–µ–Ω—è–µ—Ç –º–µ—Ç–æ–¥ reserve() —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–µ–π.
     *
     * @since 2.0.0
     */
    @Transactional
    public Integer holdCredit(@NotNull Integer walletId,
                              @Positive Long amount,
                              @NotNull UUID referenceId)
            throws WalletNotFoundException {

        // –î–ª—è –∫—Ä–µ–¥–∏—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –Ω–µ –Ω—É–∂–Ω–∞ (–≤—Ö–æ–¥—è—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞)
        return createTransaction(
            walletId,
            amount,
            TransactionType.CREDIT,
            TransactionStatus.HOLD,
            referenceId
        );
    }

    /**
     * –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç —É–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π.
     * –ó–∞–º–µ–Ω—è–µ—Ç –º–µ—Ç–æ–¥ confirm() —Å —è–≤–Ω–æ–π —Å–µ–º–∞–Ω—Ç–∏–∫–æ–π.
     *
     * @since 2.0.0
     */
    @Transactional
    public Integer release(@NotNull Integer walletId,
                           @NotNull UUID referenceId)
            throws TransactionNotFoundException {

        Transaction heldTransaction = findHeldTransaction(walletId, referenceId);

        return createTransaction(
            walletId,
            heldTransaction.getAmount(),
            heldTransaction.getType(),
            TransactionStatus.RELEASED,
            referenceId
        );
    }

    /**
     * –û—Ç–º–µ–Ω—è–µ—Ç —É–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π.
     * –ó–∞–º–µ–Ω—è–µ—Ç –º–µ—Ç–æ–¥ reject() —Å —è–≤–Ω–æ–π —Å–µ–º–∞–Ω—Ç–∏–∫–æ–π.
     *
     * @since 2.0.0
     */
    @Transactional
    public Integer cancel(@NotNull Integer walletId,
                          @NotNull UUID referenceId)
            throws TransactionNotFoundException {

        Transaction heldTransaction = findHeldTransaction(walletId, referenceId);

        return createTransaction(
            walletId,
            heldTransaction.getAmount(),
            heldTransaction.getType(),
            TransactionStatus.CANCELLED,
            referenceId
        );
    }

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ===

    private Transaction findHeldTransaction(Integer walletId, UUID referenceId)
            throws TransactionNotFoundException {
        return transactionRepository
            .findByWalletIdAndReferenceIdAndStatuses(
                walletId,
                referenceId,
                TransactionStatus.HOLD
            )
            .orElseThrow(() -> new TransactionNotFoundException(
                "No held transaction found for wallet " + walletId +
                " and reference " + referenceId
            ));
    }

    private Integer createTransaction(Integer walletId,
                                     Long amount,
                                     TransactionType type,
                                     TransactionStatus status,
                                     UUID referenceId) {
        Transaction transaction = new Transaction();
        transaction.setWalletId(walletId);
        transaction.setAmount(amount);
        transaction.setType(type);
        transaction.setStatus(status);
        transaction.setReferenceId(referenceId);

        if (status == TransactionStatus.HOLD) {
            transaction.setHoldReserveTimestamp(LocalDateTime.now());
        } else {
            transaction.setConfirmRejectTimestamp(LocalDateTime.now());
        }

        Transaction saved = transactionRepository.save(transaction);
        return saved.getId();
    }

    // === –°–¢–ê–†–´–ï –ú–ï–¢–û–î–´ (@Deprecated) ===

    /**
     * @deprecated –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {@link #holdDebit(Integer, Long, UUID)}
     */
    @Deprecated(since = "2.0.0", forRemoval = true)
    @Transactional
    public Integer hold(@NotNull Integer walletId,
                        @Positive Long amount,
                        @NotNull UUID referenceId)
            throws WalletNotFoundException, InsufficientFundsException {
        log.warn("Deprecated method hold() called. Use holdDebit() instead.");
        return holdDebit(walletId, amount, referenceId);
    }

    /**
     * @deprecated –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {@link #holdCredit(Integer, Long, UUID)}
     */
    @Deprecated(since = "2.0.0", forRemoval = true)
    @Transactional
    public Integer reserve(@NotNull Integer walletId,
                           @Positive Long amount,
                           @NotNull UUID referenceId)
            throws WalletNotFoundException {
        log.warn("Deprecated method reserve() called. Use holdCredit() instead.");
        return holdCredit(walletId, amount, referenceId);
    }

    /**
     * @deprecated –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {@link #release(Integer, UUID)}
     */
    @Deprecated(since = "2.0.0", forRemoval = true)
    @Transactional
    public Integer confirm(@NotNull Integer walletId,
                           @NotNull UUID referenceId)
            throws TransactionNotFoundException {
        log.warn("Deprecated method confirm() called. Use release() instead.");
        return release(walletId, referenceId);
    }

    /**
     * @deprecated –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {@link #cancel(Integer, UUID)}
     */
    @Deprecated(since = "2.0.0", forRemoval = true)
    @Transactional
    public Integer reject(@NotNull Integer walletId,
                          @NotNull UUID referenceId)
            throws TransactionNotFoundException {
        log.warn("Deprecated method reject() called. Use cancel() instead.");
        return cancel(walletId, referenceId);
    }
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/service/WalletService.java`

---

#### –®–∞–≥ 1.2.2: TransactionService ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã

```java
@Service
@Validated
@AllArgsConstructor
@Slf4j
public class TransactionService {

    // === –ù–û–í–´–ï –ú–ï–¢–û–î–´ ===

    /**
     * –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –≥—Ä—É–ø–ø–µ
     *
     * @since 2.0.0
     */
    @Transactional
    public void releaseTransactionGroup(@NotNull UUID referenceId)
            throws TransactionNotFoundException, TransactionGroupZeroingOutException {

        TransactionGroup group = getTransactionGroup(referenceId);

        // Zero-sum –ø—Ä–æ–≤–µ—Ä–∫–∞
        validateZeroSum(referenceId);

        // Release –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        List<Transaction> transactions =
            transactionRepository.findByReferenceIdOrderByIdDesc(referenceId);

        for (Transaction tx : transactions) {
            walletService.release(tx.getWalletId(), referenceId);
        }

        group.setStatus(TransactionGroupStatus.RELEASED);
        transactionGroupRepository.save(group);
    }

    /**
     * –û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –≥—Ä—É–ø–ø–µ
     *
     * @since 2.0.0
     */
    @Transactional
    public void cancelTransactionGroup(@NotNull UUID referenceId,
                                       @NotEmpty String reason)
            throws TransactionNotFoundException {

        TransactionGroup group = getTransactionGroup(referenceId);

        // Cancel –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        List<Transaction> transactions =
            transactionRepository.findByReferenceIdOrderByIdDesc(referenceId);

        for (Transaction tx : transactions) {
            walletService.cancel(tx.getWalletId(), referenceId);
        }

        group.setStatus(TransactionGroupStatus.CANCELLED);
        group.setReason(reason);
        transactionGroupRepository.save(group);
    }

    // === DEPRECATED –ú–ï–¢–û–î–´ ===

    /**
     * @deprecated –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {@link #releaseTransactionGroup(UUID)}
     */
    @Deprecated(since = "2.0.0", forRemoval = true)
    @Transactional
    public void confirmTransactionGroup(@NotNull UUID referenceId)
            throws TransactionNotFoundException, TransactionGroupZeroingOutException {
        log.warn("Deprecated method confirmTransactionGroup() called. " +
                 "Use releaseTransactionGroup() instead.");
        releaseTransactionGroup(referenceId);
    }

    /**
     * @deprecated –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {@link #cancelTransactionGroup(UUID, String)}
     */
    @Deprecated(since = "2.0.0", forRemoval = true)
    @Transactional
    public void rejectTransactionGroup(@NotNull UUID referenceId,
                                       @NotEmpty String reason)
            throws TransactionNotFoundException {
        log.warn("Deprecated method rejectTransactionGroup() called. " +
                 "Use cancelTransactionGroup() instead.");
        cancelTransactionGroup(referenceId, reason);
    }

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ===

    private TransactionGroup getTransactionGroup(UUID referenceId) {
        return transactionGroupRepository.findById(referenceId)
            .orElseThrow(() -> new EntityNotFoundException(
                "No transaction group found: " + referenceId
            ));
    }

    private void validateZeroSum(UUID referenceId)
            throws TransactionGroupZeroingOutException {
        Long reconciliationAmount =
            transactionRepository.getReconciliationAmountByGroupId(referenceId);

        if (reconciliationAmount != 0) {
            throw new TransactionGroupZeroingOutException(
                "Transaction group " + referenceId + " is not reconciled. " +
                "Sum: " + reconciliationAmount
            );
        }
    }
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/service/TransactionService.java`

---

### 1.3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –®–∞–≥ 1.3.1: Unit Tests

```java
@SpringBootTest
class WalletServiceTest extends TestBase {

    @Test
    void testHoldDebit_Success() {
        // Given
        Integer walletId = createWalletWithBalance(10000L);
        UUID groupId = UUID.randomUUID();

        // When
        Integer txId = walletService.holdDebit(walletId, 1000L, groupId);

        // Then
        assertThat(txId).isNotNull();
        Long balance = walletBalanceService.getAvailableBalance(walletId);
        assertThat(balance).isEqualTo(9000L); // 10000 - 1000
    }

    @Test
    void testHoldCredit_Success() {
        // Given
        Integer walletId = createWallet();
        UUID groupId = UUID.randomUUID();

        // When
        Integer txId = walletService.holdCredit(walletId, 1000L, groupId);

        // Then
        assertThat(txId).isNotNull();
        // –°—Ä–µ–¥—Å—Ç–≤–∞ –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã (—Ç–æ–ª—å–∫–æ HOLD)
        Long balance = walletBalanceService.getAvailableBalance(walletId);
        assertThat(balance).isEqualTo(0L);
    }

    @Test
    void testRelease_Success() {
        // Given
        Integer walletId = createWalletWithBalance(10000L);
        UUID groupId = UUID.randomUUID();
        walletService.holdDebit(walletId, 1000L, groupId);

        // When
        Integer txId = walletService.release(walletId, groupId);

        // Then
        assertThat(txId).isNotNull();

        Transaction tx = transactionRepository.findById(txId).orElseThrow();
        assertThat(tx.getStatus()).isEqualTo(TransactionStatus.RELEASED);
    }

    @Test
    void testCancel_Success() {
        // Given
        Integer walletId = createWalletWithBalance(10000L);
        UUID groupId = UUID.randomUUID();
        walletService.holdDebit(walletId, 1000L, groupId);

        // When
        walletService.cancel(walletId, groupId);

        // Then
        Long balance = walletBalanceService.getAvailableBalance(walletId);
        assertThat(balance).isEqualTo(10000L); // –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–µ—Ä–Ω—É–ª–∏—Å—å
    }

    @Test
    void testBackwardCompatibility_HoldMethod() {
        // Given
        Integer walletId = createWalletWithBalance(10000L);
        UUID groupId = UUID.randomUUID();

        // When (–∏—Å–ø–æ–ª—å–∑—É–µ–º deprecated –º–µ—Ç–æ–¥)
        @SuppressWarnings("deprecation")
        Integer txId = walletService.hold(walletId, 1000L, groupId);

        // Then (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–∞–∫ –∂–µ)
        assertThat(txId).isNotNull();
        Long balance = walletBalanceService.getAvailableBalance(walletId);
        assertThat(balance).isEqualTo(9000L);
    }
}
```

**–§–∞–π–ª**: `service/src/test/java/com/nosota/mwallet/tests/WalletServiceTerminologyTest.java`

---

### 1.4. Deliverables –§–∞–∑—ã 1

- ‚úÖ –ù–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã –≤ `TransactionStatus` enum
- ‚úÖ Mapper –¥–ª—è —Å—Ç–∞—Ä—ã—Ö/–Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
- ‚úÖ –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –≤ `WalletService` (holdDebit, holdCredit, release, cancel)
- ‚úÖ –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –≤ `TransactionService` (releaseTransactionGroup, cancelTransactionGroup)
- ‚úÖ @Deprecated –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–¥–∞—Ö
- ‚úÖ Unit tests –¥–ª—è –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤
- ‚úÖ Backward compatibility tests
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)

---

## –§–∞–∑–∞ 2: Settlement –ú–µ—Ö–∞–Ω–∏–∑–º

**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ (settlement)

**–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã**: 60 —á–∞—Å–æ–≤

**–†–∏—Å–∫**: –í—ã—Å–æ–∫–∏–π (–∏–∑–º–µ–Ω–µ–Ω–∏–µ core –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏)

### 2.1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è Settlement

**–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**:
```
HOLD ‚Üí RELEASED ‚Üí SETTLED
  ‚Üì        ‚Üì         ‚Üì
–£–¥–µ—Ä–∂–∞–Ω–∏–µ ‚Üí –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ ‚Üí –§–∏–Ω–∞–ª—å–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ
```

**–û—Ç–ª–∏—á–∏—è**:
- **RELEASED**: –°—Ä–µ–¥—Å—Ç–≤–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã, –Ω–æ –µ—â—ë –Ω–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ
- **SETTLED**: –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω, –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞

### 2.2. –ù–æ–≤—ã–µ –ú–µ—Ç–æ–¥—ã

#### –®–∞–≥ 2.2.1: WalletService.settle()

```java
/**
 * –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ—Å–ª–µ release.
 * –û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞.
 *
 * @since 2.0.0
 */
@Transactional
public Integer settle(@NotNull Integer walletId,
                      @NotNull UUID referenceId)
        throws TransactionNotFoundException {

    // –ù–∞–π—Ç–∏ RELEASED —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    Optional<Transaction> releasedTx = transactionRepository
        .findByWalletIdAndReferenceIdAndStatuses(
            walletId,
            referenceId,
            TransactionStatus.RELEASED
        );

    if (!releasedTx.isPresent()) {
        throw new TransactionNotFoundException(
            "No released transaction found for wallet " + walletId
        );
    }

    Transaction released = releasedTx.get();

    // –°–æ–∑–¥–∞—Ç—å SETTLED —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    Transaction settlement = new Transaction();
    settlement.setWalletId(walletId);
    settlement.setAmount(released.getAmount());
    settlement.setType(released.getType());
    settlement.setStatus(TransactionStatus.SETTLED);
    settlement.setReferenceId(referenceId);
    settlement.setConfirmRejectTimestamp(LocalDateTime.now());
    settlement.setDescription("Settlement for transaction " + released.getId());

    Transaction saved = transactionRepository.save(settlement);

    log.info("Settled transaction {} for wallet {}",
             saved.getId(), walletId);

    return saved.getId();
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/service/WalletService.java`

---

#### –®–∞–≥ 2.2.2: TransactionService.settleTransactionGroup()

```java
/**
 * –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –≥—Ä—É–ø–ø–µ.
 * –ì—Ä—É–ø–ø–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Å—Ç–∞—Ç—É—Å–µ RELEASED.
 *
 * @since 2.0.0
 */
@Transactional
public void settleTransactionGroup(@NotNull UUID referenceId)
        throws TransactionNotFoundException {

    TransactionGroup group = getTransactionGroup(referenceId);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –≥—Ä—É–ø–ø–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å RELEASED
    if (group.getStatus() != TransactionGroupStatus.RELEASED) {
        throw new IllegalStateException(
            "Cannot settle group " + referenceId +
            " in status " + group.getStatus() +
            ". Must be RELEASED first."
        );
    }

    // Settle –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    List<Transaction> transactions =
        transactionRepository.findByReferenceIdOrderByIdDesc(referenceId);

    for (Transaction tx : transactions) {
        walletService.settle(tx.getWalletId(), referenceId);
    }

    group.setStatus(TransactionGroupStatus.SETTLED);
    transactionGroupRepository.save(group);

    log.info("Settled transaction group {}", referenceId);
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/service/TransactionService.java`

---

### 2.3. –û–±–Ω–æ–≤–∏—Ç—å TransactionGroupStatus

```java
public enum TransactionGroupStatus {
    IN_PROGRESS,  // –°–æ–∑–¥–∞—ë—Ç—Å—è
    RELEASED,     // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (NEW!)
    SETTLED,      // –§–∏–Ω–∞–ª—å–Ω–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ (NEW!)
    CANCELLED,    // –û—Ç–º–µ–Ω–µ–Ω–æ (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –∏–∑ REJECTED)

    @Deprecated(since = "2.0.0", forRemoval = true)
    CONFIRMED,    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ RELEASED –∏–ª–∏ SETTLED

    @Deprecated(since = "2.0.0", forRemoval = true)
    REJECTED;     // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CANCELLED
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/model/TransactionGroupStatus.java`

---

### 2.4. –ù–æ–≤—ã–π Workflow

```java
/**
 * –ü—Ä–∏–º–µ—Ä: –ü–µ—Ä–µ–≤–æ–¥ —Å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–º settlement
 */
@Transactional(Transactional.TxType.NOT_SUPPORTED)
public UUID transferWithImmediateSettlement(Integer senderId,
                                            Integer recipientId,
                                            Long amount) throws Exception {
    UUID groupId = createTransactionGroup();

    try {
        // 1. Hold —Å—Ä–µ–¥—Å—Ç–≤–∞
        walletService.holdDebit(senderId, amount, groupId);
        walletService.holdCredit(recipientId, amount, groupId);

        // 2. Release (—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
        releaseTransactionGroup(groupId);

        // 3. Settlement (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥)
        settleTransactionGroup(groupId);

    } catch (Exception e) {
        cancelTransactionGroup(groupId, e.getMessage());
        throw e;
    }

    return groupId;
}

/**
 * –ü—Ä–∏–º–µ—Ä: Escrow —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º settlement
 */
@Transactional(Transactional.TxType.NOT_SUPPORTED)
public UUID escrowTransfer(Integer buyerId,
                          Integer escrowWalletId,
                          Long amount) throws Exception {
    UUID groupId = createTransactionGroup();

    try {
        // 1. Hold —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ escrow
        walletService.holdDebit(buyerId, amount, groupId);
        walletService.holdCredit(escrowWalletId, amount, groupId);

        // 2. Release –≤ escrow (–ø—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–≥—Ä—É–∑–∏–ª —Ç–æ–≤–∞—Ä)
        releaseTransactionGroup(groupId);

        // 3. Settlement –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è!
        // –í—ã–∑–æ–≤–µ—Ç—Å—è –ø–æ–∑–∂–µ: settleTransactionGroup(groupId)

    } catch (Exception e) {
        cancelTransactionGroup(groupId, e.getMessage());
        throw e;
    }

    return groupId;
}
```

---

### 2.5. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö

```sql
-- V2.02__add_settlement_status.sql

-- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
COMMENT ON COLUMN transaction_group.status IS
'Group status: IN_PROGRESS, RELEASED, SETTLED, CANCELLED (CONFIRMED and REJECTED deprecated)';

-- –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≥—Ä—É–ø–ø –¥–ª—è settlement
CREATE INDEX idx_transaction_group_status_released
ON transaction_group(status)
WHERE status = 'RELEASED';

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
CREATE OR REPLACE FUNCTION validate_transaction_group_status_transition()
RETURNS TRIGGER AS $$
BEGIN
    -- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π
    IF OLD.status = 'SETTLED' AND NEW.status != 'SETTLED' THEN
        RAISE EXCEPTION 'Cannot change status from SETTLED';
    END IF;

    IF OLD.status = 'CANCELLED' AND NEW.status != 'CANCELLED' THEN
        RAISE EXCEPTION 'Cannot change status from CANCELLED';
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
CREATE TRIGGER validate_status_transition
BEFORE UPDATE ON transaction_group
FOR EACH ROW
WHEN (OLD.status IS DISTINCT FROM NEW.status)
EXECUTE FUNCTION validate_transaction_group_status_transition();
```

---

### 2.6. Deliverables –§–∞–∑—ã 2

- ‚úÖ –ú–µ—Ç–æ–¥ `WalletService.settle()`
- ‚úÖ –ú–µ—Ç–æ–¥ `TransactionService.settleTransactionGroup()`
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `TransactionGroupStatus` enum
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Unit tests –¥–ª—è settlement
- ‚úÖ Integration tests –¥–ª—è escrow workflow
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è workflow (HOLD ‚Üí RELEASED ‚Üí SETTLED)

---

## –§–∞–∑–∞ 3: Ledger Service

**–¶–µ–ª—å**: –í—ã–¥–µ–ª–∏—Ç—å Ledger Service –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã**: 80 —á–∞—Å–æ–≤

**–†–∏—Å–∫**: –°—Ä–µ–¥–Ω–∏–π (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)

### 3.1. –ù–æ–≤–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
WalletService: hold, reserve, confirm, reject
TransactionService: createGroup, confirmGroup, rejectGroup

–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞:
LedgerService: holdFunds, releaseFunds, cancelHold, settleFunds
TransactionGroupService: createGroup, releaseGroup, cancelGroup, settleGroup
WalletService: createWallet, getBalance (–±–µ–∑ ledger-–ª–æ–≥–∏–∫–∏)
```

### 3.2. –°–æ–∑–¥–∞—Ç—å LedgerService

```java
/**
 * –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Ledger (–∂—É—Ä–Ω–∞–ª–æ–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π).
 * Centralizes all ledger operations.
 *
 * @since 2.0.0
 */
@Service
@Validated
@AllArgsConstructor
@Slf4j
public class LedgerService {

    private final TransactionRepository transactionRepository;
    private final WalletRepository walletRepository;
    private final WalletBalanceService walletBalanceService;

    /**
     * –£–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ (debit).
     */
    @Transactional
    public LedgerEntry holdDebit(@NotNull Integer walletId,
                                 @Positive Long amount,
                                 @NotNull UUID referenceId)
            throws WalletNotFoundException, InsufficientFundsException {

        validateWalletExists(walletId);
        validateSufficientBalance(walletId, amount);

        return createLedgerEntry(
            walletId,
            -amount,
            TransactionType.DEBIT,
            TransactionStatus.HOLD,
            referenceId,
            "Hold debit: " + amount + " cents"
        );
    }

    /**
     * –£–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ (credit).
     */
    @Transactional
    public LedgerEntry holdCredit(@NotNull Integer walletId,
                                  @Positive Long amount,
                                  @NotNull UUID referenceId)
            throws WalletNotFoundException {

        validateWalletExists(walletId);

        return createLedgerEntry(
            walletId,
            amount,
            TransactionType.CREDIT,
            TransactionStatus.HOLD,
            referenceId,
            "Hold credit: " + amount + " cents"
        );
    }

    /**
     * –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç —É–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞.
     */
    @Transactional
    public LedgerEntry releaseFunds(@NotNull Integer walletId,
                                    @NotNull UUID referenceId)
            throws LedgerEntryNotFoundException {

        Transaction held = findHeldTransaction(walletId, referenceId);

        return createLedgerEntry(
            walletId,
            held.getAmount(),
            held.getType(),
            TransactionStatus.RELEASED,
            referenceId,
            "Release funds for transaction " + held.getId()
        );
    }

    /**
     * –û—Ç–º–µ–Ω—è–µ—Ç —É–¥–µ—Ä–∂–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤.
     */
    @Transactional
    public LedgerEntry cancelHold(@NotNull Integer walletId,
                                  @NotNull UUID referenceId)
            throws LedgerEntryNotFoundException {

        Transaction held = findHeldTransaction(walletId, referenceId);

        return createLedgerEntry(
            walletId,
            held.getAmount(),
            held.getType(),
            TransactionStatus.CANCELLED,
            referenceId,
            "Cancel hold for transaction " + held.getId()
        );
    }

    /**
     * –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤.
     */
    @Transactional
    public LedgerEntry settleFunds(@NotNull Integer walletId,
                                   @NotNull UUID referenceId)
            throws LedgerEntryNotFoundException {

        Transaction released = findReleasedTransaction(walletId, referenceId);

        return createLedgerEntry(
            walletId,
            released.getAmount(),
            released.getType(),
            TransactionStatus.SETTLED,
            referenceId,
            "Settlement for transaction " + released.getId()
        );
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ ledger entries –¥–ª—è –∫–æ—à–µ–ª—å–∫–∞.
     */
    public List<LedgerEntry> getLedgerEntries(@NotNull Integer walletId) {
        List<Transaction> transactions =
            transactionRepository.findAllByWalletId(walletId);

        return transactions.stream()
            .map(this::toLedgerEntry)
            .collect(Collectors.toList());
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å ledger entries –¥–ª—è –≥—Ä—É–ø–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
     */
    public List<LedgerEntry> getLedgerEntriesByGroup(@NotNull UUID referenceId) {
        List<Transaction> transactions =
            transactionRepository.findByReferenceId(referenceId);

        return transactions.stream()
            .map(this::toLedgerEntry)
            .collect(Collectors.toList());
    }

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ===

    private LedgerEntry createLedgerEntry(Integer walletId,
                                          Long amount,
                                          TransactionType type,
                                          TransactionStatus status,
                                          UUID referenceId,
                                          String description) {
        Transaction transaction = new Transaction();
        transaction.setWalletId(walletId);
        transaction.setAmount(amount);
        transaction.setType(type);
        transaction.setStatus(status);
        transaction.setReferenceId(referenceId);
        transaction.setDescription(description);

        if (status == TransactionStatus.HOLD) {
            transaction.setHoldReserveTimestamp(LocalDateTime.now());
        } else {
            transaction.setConfirmRejectTimestamp(LocalDateTime.now());
        }

        Transaction saved = transactionRepository.save(transaction);

        log.info("Created ledger entry: wallet={}, amount={}, type={}, status={}",
                 walletId, amount, type, status);

        return toLedgerEntry(saved);
    }

    private Transaction findHeldTransaction(Integer walletId, UUID referenceId)
            throws LedgerEntryNotFoundException {
        return transactionRepository
            .findByWalletIdAndReferenceIdAndStatuses(
                walletId,
                referenceId,
                TransactionStatus.HOLD
            )
            .orElseThrow(() -> new LedgerEntryNotFoundException(
                "No held transaction found for wallet " + walletId
            ));
    }

    private Transaction findReleasedTransaction(Integer walletId, UUID referenceId)
            throws LedgerEntryNotFoundException {
        return transactionRepository
            .findByWalletIdAndReferenceIdAndStatuses(
                walletId,
                referenceId,
                TransactionStatus.RELEASED
            )
            .orElseThrow(() -> new LedgerEntryNotFoundException(
                "No released transaction found for wallet " + walletId
            ));
    }

    private void validateWalletExists(Integer walletId)
            throws WalletNotFoundException {
        if (!walletRepository.existsById(walletId)) {
            throw new WalletNotFoundException(
                "Wallet not found: " + walletId
            );
        }
    }

    private void validateSufficientBalance(Integer walletId, Long amount)
            throws InsufficientFundsException {
        Long available = walletBalanceService.getAvailableBalance(walletId);
        if (available < amount) {
            throw new InsufficientFundsException(
                "Insufficient funds in wallet " + walletId +
                ": available=" + available + ", required=" + amount
            );
        }
    }

    private LedgerEntry toLedgerEntry(Transaction transaction) {
        return LedgerEntry.builder()
            .id(transaction.getId())
            .walletId(transaction.getWalletId())
            .amount(transaction.getAmount())
            .type(transaction.getType())
            .status(transaction.getStatus())
            .referenceId(transaction.getReferenceId())
            .timestamp(transaction.getConfirmRejectTimestamp() != null
                ? transaction.getConfirmRejectTimestamp()
                : transaction.getHoldReserveTimestamp())
            .description(transaction.getDescription())
            .build();
    }
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/service/LedgerService.java`

---

### 3.3. LedgerEntry DTO

```java
/**
 * Ledger Entry DTO - –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ ledger.
 *
 * @since 2.0.0
 */
@Data
@Builder
public class LedgerEntry {
    private Integer id;
    private Integer walletId;
    private Long amount;
    private TransactionType type;
    private TransactionStatus status;
    private UUID referenceId;
    private LocalDateTime timestamp;
    private String description;

    /**
     * –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø–∏—Å—å –¥–µ–±–µ—Ç–æ–º (—Å–ø–∏—Å–∞–Ω–∏–µ)
     */
    public boolean isDebit() {
        return type == TransactionType.DEBIT;
    }

    /**
     * –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø–∏—Å—å –∫—Ä–µ–¥–∏—Ç–æ–º (–∑–∞—á–∏—Å–ª–µ–Ω–∏–µ)
     */
    public boolean isCredit() {
        return type == TransactionType.CREDIT;
    }

    /**
     * –§–∏–Ω–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å (settled –∏–ª–∏ cancelled)
     */
    public boolean isFinal() {
        return status == TransactionStatus.SETTLED
            || status == TransactionStatus.CANCELLED;
    }
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/dto/LedgerEntry.java`

---

### 3.4. TransactionGroupService

```java
/**
 * –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–∞–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
 * Uses LedgerService for all ledger operations.
 *
 * @since 2.0.0
 */
@Service
@Validated
@AllArgsConstructor
@Slf4j
public class TransactionGroupService {

    private final TransactionGroupRepository transactionGroupRepository;
    private final TransactionRepository transactionRepository;
    private final LedgerService ledgerService;

    @Transactional
    public UUID createGroup() {
        TransactionGroup group = new TransactionGroup();
        group.setStatus(TransactionGroupStatus.IN_PROGRESS);
        group = transactionGroupRepository.save(group);
        return group.getId();
    }

    @Transactional
    public void releaseGroup(@NotNull UUID groupId)
            throws TransactionGroupZeroingOutException {

        TransactionGroup group = getGroup(groupId);
        validateZeroSum(groupId);

        List<Transaction> transactions =
            transactionRepository.findByReferenceIdOrderByIdDesc(groupId);

        for (Transaction tx : transactions) {
            ledgerService.releaseFunds(tx.getWalletId(), groupId);
        }

        group.setStatus(TransactionGroupStatus.RELEASED);
        transactionGroupRepository.save(group);
    }

    @Transactional
    public void cancelGroup(@NotNull UUID groupId, @NotEmpty String reason) {
        TransactionGroup group = getGroup(groupId);

        List<Transaction> transactions =
            transactionRepository.findByReferenceIdOrderByIdDesc(groupId);

        for (Transaction tx : transactions) {
            ledgerService.cancelHold(tx.getWalletId(), groupId);
        }

        group.setStatus(TransactionGroupStatus.CANCELLED);
        group.setReason(reason);
        transactionGroupRepository.save(group);
    }

    @Transactional
    public void settleGroup(@NotNull UUID groupId) {
        TransactionGroup group = getGroup(groupId);

        if (group.getStatus() != TransactionGroupStatus.RELEASED) {
            throw new IllegalStateException(
                "Cannot settle group in status " + group.getStatus()
            );
        }

        List<Transaction> transactions =
            transactionRepository.findByReferenceIdOrderByIdDesc(groupId);

        for (Transaction tx : transactions) {
            ledgerService.settleFunds(tx.getWalletId(), groupId);
        }

        group.setStatus(TransactionGroupStatus.SETTLED);
        transactionGroupRepository.save(group);
    }

    private TransactionGroup getGroup(UUID groupId) {
        return transactionGroupRepository.findById(groupId)
            .orElseThrow(() -> new EntityNotFoundException(
                "Transaction group not found: " + groupId
            ));
    }

    private void validateZeroSum(UUID groupId)
            throws TransactionGroupZeroingOutException {
        Long sum = transactionRepository.getReconciliationAmountByGroupId(groupId);
        if (sum != 0) {
            throw new TransactionGroupZeroingOutException(
                "Group " + groupId + " doesn't balance to zero: sum=" + sum
            );
        }
    }
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/service/TransactionGroupService.java`

---

### 3.5. –û–±–Ω–æ–≤–∏—Ç—å WalletService

–£–¥–∞–ª–∏—Ç—å ledger-–ª–æ–≥–∏–∫—É –∏–∑ WalletService, –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ LedgerService:

```java
@Service
@Validated
@AllArgsConstructor
@Slf4j
public class WalletService {

    private final LedgerService ledgerService;

    /**
     * @deprecated Use {@link LedgerService#holdDebit(Integer, Long, UUID)}
     */
    @Deprecated(since = "2.0.0", forRemoval = true)
    public Integer holdDebit(Integer walletId, Long amount, UUID referenceId) {
        return ledgerService.holdDebit(walletId, amount, referenceId).getId();
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã —É–¥–∞–ª–µ–Ω—ã - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ LedgerService
}
```

---

### 3.6. Deliverables –§–∞–∑—ã 3

- ‚úÖ `LedgerService` —Å –≤—Å–µ–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- ‚úÖ `LedgerEntry` DTO
- ‚úÖ `TransactionGroupService` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç LedgerService)
- ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `WalletService` (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ LedgerService)
- ‚úÖ Unit tests –¥–ª—è LedgerService
- ‚úÖ Integration tests –¥–ª—è –≤—Å–µ–π —Ü–µ–ø–æ—á–∫–∏
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤

---

## –§–∞–∑–∞ 4: Batch Processing

**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å batch settlement –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã**: 100 —á–∞—Å–æ–≤

**–†–∏—Å–∫**: –í—ã—Å–æ–∫–∏–π (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

### 4.1. SettlementBatchService

```java
/**
 * –°–µ—Ä–≤–∏—Å –ø–∞–∫–µ—Ç–Ω–æ–≥–æ settlement.
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥—Ä—É–ø–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–∞–∫–µ—Ç–∞–º–∏.
 *
 * @since 2.0.0
 */
@Service
@Slf4j
@AllArgsConstructor
public class SettlementBatchService {

    private final TransactionGroupRepository transactionGroupRepository;
    private final TransactionGroupService transactionGroupService;

    /**
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç batch settlement –¥–ª—è –≤—Å–µ—Ö RELEASED –≥—Ä—É–ø–ø.
     */
    @Scheduled(cron = "${mwallet.settlement.batch.cron:0 0 3 * * *}") // 3 AM
    public void scheduledBatchSettlement() {
        log.info("Starting scheduled batch settlement");

        LocalDateTime cutoff = LocalDateTime.now().minusHours(24);

        BatchSettlementResult result = settleBatch(
            TransactionGroupStatus.RELEASED,
            cutoff
        );

        log.info("Batch settlement completed: {}", result);
    }

    /**
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç batch settlement –¥–ª—è –≥—Ä—É–ø–ø –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ.
     */
    @Transactional
    public BatchSettlementResult settleBatch(
            @NotNull TransactionGroupStatus status,
            @NotNull LocalDateTime olderThan) {

        // –ù–∞–π—Ç–∏ –≥—Ä—É–ø–ø—ã –¥–ª—è settlement
        List<TransactionGroup> groups = transactionGroupRepository
            .findByStatusAndCreatedAtBefore(status, olderThan);

        int successCount = 0;
        int errorCount = 0;
        List<UUID> failed = new ArrayList<>();

        for (TransactionGroup group : groups) {
            try {
                transactionGroupService.settleGroup(group.getId());
                successCount++;
            } catch (Exception e) {
                errorCount++;
                failed.add(group.getId());
                log.error("Failed to settle group {}: {}",
                         group.getId(), e.getMessage(), e);
            }
        }

        return BatchSettlementResult.builder()
            .timestamp(LocalDateTime.now())
            .totalGroups(groups.size())
            .successCount(successCount)
            .errorCount(errorCount)
            .failedGroups(failed)
            .build();
    }

    /**
     * –û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ IN_PROGRESS –≥—Ä—É–ø–ø—ã (cleanup).
     */
    @Scheduled(cron = "${mwallet.cleanup.stale.cron:0 0 4 * * *}") // 4 AM
    public void cleanupStaleGroups() {
        log.info("Starting cleanup of stale transaction groups");

        LocalDateTime cutoff = LocalDateTime.now().minusDays(7); // 7 –¥–Ω–µ–π

        List<TransactionGroup> staleGroups = transactionGroupRepository
            .findByStatusAndCreatedAtBefore(
                TransactionGroupStatus.IN_PROGRESS,
                cutoff
            );

        for (TransactionGroup group : staleGroups) {
            try {
                transactionGroupService.cancelGroup(
                    group.getId(),
                    "Cancelled: stale group (> 7 days old)"
                );
                log.warn("Cancelled stale group: {}", group.getId());
            } catch (Exception e) {
                log.error("Failed to cancel stale group {}: {}",
                         group.getId(), e.getMessage(), e);
            }
        }
    }
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/service/SettlementBatchService.java`

---

### 4.2. BatchSettlementResult

```java
@Data
@Builder
public class BatchSettlementResult {
    private LocalDateTime timestamp;
    private int totalGroups;
    private int successCount;
    private int errorCount;
    private List<UUID> failedGroups;

    public double getSuccessRate() {
        return totalGroups > 0
            ? (double) successCount / totalGroups * 100
            : 0;
    }
}
```

**–§–∞–π–ª**: `service/src/main/java/com/nosota/mwallet/dto/BatchSettlementResult.java`

---

### 4.3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
# application.yaml
mwallet:
  settlement:
    batch:
      enabled: true
      cron: "0 0 3 * * *"  # 3 AM daily
      page-size: 1000      # Process 1000 groups at a time
  cleanup:
    stale:
      enabled: true
      cron: "0 0 4 * * *"  # 4 AM daily
      threshold-days: 7    # Groups older than 7 days
```

---

### 4.4. –†–∞—Å—à–∏—Ä–∏—Ç—å Repository

```java
public interface TransactionGroupRepository extends JpaRepository<TransactionGroup, UUID> {

    /**
     * –ù–∞–π—Ç–∏ –≥—Ä—É–ø–ø—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
     */
    List<TransactionGroup> findByStatusAndCreatedAtBefore(
        TransactionGroupStatus status,
        LocalDateTime before
    );

    /**
     * –ü–æ—Å—á–∏—Ç–∞—Ç—å –≥—Ä—É–ø–ø—ã –≤ —Å—Ç–∞—Ç—É—Å–µ
     */
    long countByStatus(TransactionGroupStatus status);
}
```

---

### 4.5. Deliverables –§–∞–∑—ã 4

- ‚úÖ `SettlementBatchService` —Å scheduled jobs
- ‚úÖ `BatchSettlementResult` DTO
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è batch processing
- ‚úÖ Cleanup job –¥–ª—è stale groups
- ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π `TransactionGroupRepository`
- ‚úÖ Performance tests (–æ–±—Ä–∞–±–æ—Ç–∫–∞ 10K+ –≥—Ä—É–ø–ø)
- ‚úÖ Monitoring –∏ –∞–ª–µ—Ä—Ç—ã

---

## –§–∞–∑–∞ 5: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è

**–¶–µ–ª—å**: –û–±–Ω–æ–≤–∏—Ç—å –≤—Å—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã**: 20 —á–∞—Å–æ–≤

**–†–∏—Å–∫**: –ù–∏–∑–∫–∏–π

### 5.1. –û–±–Ω–æ–≤–∏—Ç—å –î–æ–∫—É–º–µ–Ω—Ç—ã

- ‚úÖ `docs/architecture/transaction-lifecycle.md` ‚Äî –Ω–æ–≤—ã–π workflow
- ‚úÖ `docs/api/services.md` ‚Äî LedgerService API
- ‚úÖ `docs/operations/settlement.md` ‚Äî batch settlement operations
- ‚úÖ `RELEASES.md` ‚Äî release notes –¥–ª—è v2.0.0
- ‚úÖ `CHANGELOG.md` ‚Äî –¥–µ—Ç–∞–ª—å–Ω—ã–π changelog

### 5.2. –°–æ–∑–¥–∞—Ç—å Migration Guide

```markdown
# Migration Guide: v1.0.5 ‚Üí v2.0.0

## Breaking Changes

### Terminology Changes

| Old | New | Migration |
|-----|-----|-----------|
| `RESERVE` status | `HOLD` | Use `holdCredit()` |
| `CONFIRMED` status | `RELEASED` or `SETTLED` | Context-dependent |
| `REJECTED` status | `CANCELLED` | Use `cancel()` |
| `WalletService.hold()` | `LedgerService.holdDebit()` | Direct replacement |
| `WalletService.reserve()` | `LedgerService.holdCredit()` | Direct replacement |
| `WalletService.confirm()` | `LedgerService.releaseFunds()` | Direct replacement |
| `WalletService.reject()` | `LedgerService.cancelHold()` | Direct replacement |

### Code Migration Examples

#### Before (v1.0.5)
```java
walletService.hold(senderId, amount, groupId);
walletService.reserve(recipientId, amount, groupId);
transactionService.confirmTransactionGroup(groupId);
```

#### After (v2.0.0)
```java
ledgerService.holdDebit(senderId, amount, groupId);
ledgerService.holdCredit(recipientId, amount, groupId);
transactionGroupService.releaseGroup(groupId);
transactionGroupService.settleGroup(groupId);
```
```

---

## –†–∏—Å–∫–∏ –∏ –ú–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫ 1: Breaking Changes –¥–ª—è –ö–ª–∏–µ–Ω—Ç–æ–≤

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: –í—ã—Å–æ–∫–∞—è
**–í–ª–∏—è–Ω–∏–µ**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
1. ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã —Å @Deprecated
2. ‚úÖ Feature flags –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
3. ‚úÖ Migration guide –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
4. ‚úÖ –î–ª–∏—Ç–µ–ª—å–Ω—ã–π deprecation period (6-12 –º–µ—Å—è—Ü–µ–≤)

### –†–∏—Å–∫ 2: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å Batch Processing

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
**–í–ª–∏—è–Ω–∏–µ**: –í—ã—Å–æ–∫–æ–µ

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
1. ‚úÖ Performance tests –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º
2. ‚úÖ Pagination –¥–ª—è –±–æ–ª—å—à–∏—Ö batch
3. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
4. ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∏—Ç—å batch processing

### –†–∏—Å–∫ 3: Data Corruption –ø—Ä–∏ –ú–∏–≥—Ä–∞—Ü–∏–∏

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è
**–í–ª–∏—è–Ω–∏–µ**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
1. ‚úÖ Comprehensive tests –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
2. ‚úÖ Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ Rollback plan
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ reconciliation –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### –†–∏—Å–∫ 4: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è
**–í–ª–∏—è–Ω–∏–µ**: –í—ã—Å–æ–∫–æ–µ

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
1. ‚úÖ Unit tests (coverage > 90%)
2. ‚úÖ Integration tests
3. ‚úÖ End-to-end tests
4. ‚úÖ Load testing
5. ‚úÖ Staging environment —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –ß–µ–∫–ª–∏—Å—Ç

### Pre-Implementation

- [ ] –°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –ø–ª–∞–Ω —Å –∫–æ–º–∞–Ω–¥–æ–π
- [ ] –°–æ–∑–¥–∞—Ç—å feature branch: `feature/ledger-compliance`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å feature flags
- [ ] –°–æ–∑–¥–∞—Ç—å test environment

### –§–∞–∑–∞ 1: –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è

- [ ] –†–∞—Å—à–∏—Ä–∏—Ç—å `TransactionStatus` enum
- [ ] –°–æ–∑–¥–∞—Ç—å `TransactionStatusMapper`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –≤ `WalletService`
- [ ] @Deprecated —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã
- [ ] Unit tests (coverage > 90%)
- [ ] Integration tests
- [ ] Code review
- [ ] Merge –≤ develop

### –§–∞–∑–∞ 2: Settlement

- [ ] –î–æ–±–∞–≤–∏—Ç—å `settle()` –º–µ—Ç–æ–¥—ã
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `TransactionGroupStatus`
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] Unit tests –¥–ª—è settlement
- [ ] Integration tests –¥–ª—è workflow
- [ ] Code review
- [ ] Merge –≤ develop

### –§–∞–∑–∞ 3: Ledger Service

- [ ] –°–æ–∑–¥–∞—Ç—å `LedgerService`
- [ ] –°–æ–∑–¥–∞—Ç—å `LedgerEntry` DTO
- [ ] –°–æ–∑–¥–∞—Ç—å `TransactionGroupService`
- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `WalletService`
- [ ] Unit tests
- [ ] Integration tests
- [ ] Performance tests
- [ ] Code review
- [ ] Merge –≤ develop

### –§–∞–∑–∞ 4: Batch Processing

- [ ] –°–æ–∑–¥–∞—Ç—å `SettlementBatchService`
- [ ] Scheduled jobs –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- [ ] Performance tests (10K+ groups)
- [ ] Monitoring –∏ –∞–ª–µ—Ä—Ç—ã
- [ ] Code review
- [ ] Merge –≤ develop

### –§–∞–∑–∞ 5: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [ ] –û–±–Ω–æ–≤–∏—Ç—å architecture docs
- [ ] –û–±–Ω–æ–≤–∏—Ç—å API docs
- [ ] –°–æ–∑–¥–∞—Ç—å migration guide
- [ ] –û–±–Ω–æ–≤–∏—Ç—å RELEASES.md
- [ ] Review –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### Pre-Release

- [ ] Full regression testing
- [ ] Load testing
- [ ] Security review
- [ ] Staging deployment
- [ ] Beta testing —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
- [ ] Final code review

### Release

- [ ] Tag –≤–µ—Ä—Å–∏–∏ v2.0.0
- [ ] Merge –≤ main
- [ ] Production deployment
- [ ] Monitoring
- [ ] Communication —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –í–æ–ø—Ä–æ—Å—ã

–ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–ª–∞–Ω—É:
1. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
2. –û—Ç–º–µ—Ç—å—Ç–µ team lead
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–∫—É `ledger-compliance`

**–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–≤—å—é –ø–ª–∞–Ω–∞**: TBD

---

**–ö–æ–Ω–µ—Ü –ø–ª–∞–Ω–∞**
